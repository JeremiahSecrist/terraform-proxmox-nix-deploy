 #Our desired pipeline using only a Nix shell environment
name: Build and plan terraform

on: workflow_dispatch

jobs:
  plan:
    name: plan
    runs-on: ubuntu-22.04
    steps:
      - name: git checkout
        uses: actions/checkout@v3

      - name: Tailscale
        uses: tailscale/github-action@v1
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            system-features = nixos-test benchmark big-parallel kvm
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      # Nix-specific logic begins here
      - name: Test the nix setup
        run: nix run
        env:
          TF_VAR_proxmox_api_token_id: ${{ secrets.PROXMOX_API_TOKEN_ID }}
          TF_VAR_proxmox_api_secret: ${{ secrets.PROXMOX_API_SECRET }}
          TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_URL }}
          
          AWS_S3_ENDPOINT: ${{ secrets.AWS_S3_ENDPOINT }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          TF_VAR_backend_s3_region: ${{ secrets.BACKEND_S3_REGION }}
          TF_VAR_backend_s3_bucket: ${{ secrets.BACKEND_S3_BUCKET }}
          TF_VAR_backend_s3_key: ${{ secrets.BACKEND_S3_KEY }}